# Using Docker to Push Sample App

This is documentation on how to use docker and dtr.predix.io to create and push a
docker image to DockerHub. The example app simply lists the names of a few basketball players
on a GET request.

## Setup and Pre-requisites

• Maven

• Project Lombok

• Docker

• PCS and Kubernetes

1) Clone the repository 
2) Run `mvn clean install` from the project root directory

## Dockerfile

The Dockerfile that I included in this repo simply gets the necessary dependencies in JDK8, exposes
port 8080 to the outside world, and put the executable JAR in the container, using the ADD command.

__Note on Volumes__

Volumes are a mechanism to persist data generated by the container on the Host OS, and share directories from the Host OS with the container. 

The `VOLUME` instruction creates a mount point on the container with the specified path; in our case `/tmp`.

Spring boot applications create working directories for Tomcat at the `/tmp` folder by default.

## Makefile

This Makefile contains several targets needed to push the image to DTR.

__build__

use the command `make build` to build the Docker image.

__run__

use the command, `make run` to run the image on port 5000 on your local machine (check localhost:5000 to see if it works.)

__tag__

user the command `make tag` to tag the image with the correct DTR repository (explained later)

## DTR

Steps to push an Image to DTR

1) Login to dtr.predix.io
2) Create a repository ex: sso/micro-service-example
3) Tag the local image with the name of the repository. The name of the repository is
`dtr.predix.io/<sso>/<name-of-repo>` - this is where you run the `make run` command.
4) Login to dtr.predix.io on terminal with `docker login dtr.predix.io`
5) Push the image with `docker push dtr.predix.io/<sso>/<name-of-repo>`

## PCS Onboarding

Remove all Proxy configurations 
```
unset http_proxy
unset https_proxy
```

1) Get access to DTR by filing ticket at https://build.ge.com/services/docker-registry/

2) Install the following

    • UAA client <= 4.1.0 - https://github.com/cloudfoundry/cf-uaac
     
    • kubectl - https://kubernetes.io/docs/tasks/tools/install-kubectl/ 

    • cygwin [optional, if using windows] - https://www.cygwin.com/

3) Using the CF1 Endpoint ([PCS Production]: https://master.system.pcs.aws-usw02-pr.ice.predix.io), run `kubectl config set-cluster "k8-pcs-cluster" --server=<PCS_API_Endpoint>`

4) Go to https://github.devtools.predix.io/industrial-cloud-pcs/onboarding/releases

5) Create directory ~/.kube/plugins/pcsgo

6) Unzip the downloaded zip file `unzip pcs-plugin-darwin64.zip -d ~/.kube/plugins/pcsgo
`
7) Login to CF: `cf login -a https://api.system.aws-usw02-pr.ice.predix.io --sso`

## Kubernetes/PCS

1) Create a yaml file with the necessary specifications like in `example.yaml`
2) Login to your dev cluster with `kubectl plugin pcs login <email> <namespace> <cluster>`
3) Change directory `cd ~/.kube/plugins/pcsgo` and run `./go-cli deploy -m /path-to-yaml`
4) Use `kubectl get pods` to check if your pod is there